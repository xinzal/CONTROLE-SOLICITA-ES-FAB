<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Solicita√ß√µes FAB</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: #f0f2f5;
    color: #333;
  }
  header {
    background: linear-gradient(90deg, #1a73e8, #4285f4);
    color: white;
    padding: 15px 10px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  header h1 {
    margin: 0;
    font-size: 1.8em;
    letter-spacing: 1px;
  }
  nav {
    display: flex;
    justify-content: center;
    background: #ffffff;
    padding: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  nav button {
    margin: 0 10px;
    padding: 10px 25px;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }
  nav button:hover {
    background: #155cb0;
    transform: translateY(-2px);
  }
  section {
    display: none;
    padding: 20px 40px;
    animation: fadeIn 0.4s;
  }
  section.active {
    display: block;
  }
  .filtros {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .filtros input, .filtros select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    transition: all 0.2s ease;
  }
  .filtros input:focus, .filtros select:focus {
    border-color: #1a73e8;
    outline: none;
    box-shadow: 0 0 5px rgba(26,115,232,0.3);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  th, td {
    padding: 12px 10px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }
  th {
    background: #f4f6f8;
    font-weight: 600;
  }
  tr:hover {
    background: #f1f5f9;
  }
  button.upload {
    background: #34a853;
    color: white;
    border-radius: 6px;
    padding: 8px 15px;
    margin-top: 5px;
    cursor: pointer;
    border: none;
    font-weight: bold;
  }
  button.upload:hover {
    background: #2c8c46;
  }
  .btn-email {
    background: #fbbc05;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s, background 0.3s;
    font-size: 18px;
  }
  .btn-email:hover {
    transform: scale(1.2);
    background: #e0a800;
  }
  form button[type="submit"] {
    background: #1a73e8;
    color: white;
    border-radius: 6px;
    padding: 10px 20px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  form button[type="submit"]:hover {
    background: #155cb0;
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
</style>
</head>
<body>
  <header>
    <h1>Controle Solicita√ß√µes FAB</h1>
  </header>

  <nav>
    <button onclick="mostrarAba('pedidos')">Pedidos</button>
    <button onclick="mostrarAba('emails')">Cadastro de Emails</button>
  </nav>

  <!-- ABA DE PEDIDOS -->
  <section id="pedidos" class="active">
    <h2>Pedidos</h2>

    <div class="filtros">
      <input type="text" id="filtroNumero" placeholder="Pesquisar por n√∫mero do pedido">
      <select id="filtroFabrica">
        <option value="">Todas as f√°bricas</option>
      </select>
    </div>

    <table id="tabelaPedidos">
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>F√°brica</th>
          <th>C√≥digo</th>
          <th>Descri√ß√£o</th>
          <th>Quantidade</th>
          <th>Data</th>
          <th>Pallets</th>
          <th>Peso</th>
          <th>Estoque</th>
          <th>PDF</th>
          <th>Upload PDF</th>
          <th>Enviar Email</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ABA DE EMAILS -->
  <section id="emails">
    <h2>Cadastro de Emails</h2>
    <form id="formEmails">
      <label>F√°brica:</label>
      <input type="text" id="fabricaEmail" required>
      <label>Email principal:</label>
      <input type="text" id="emailPrincipal" placeholder="ex: fabrica@empresa.com, outro@empresa.com">
      <label>Email c√≥pia:</label>
      <input type="text" id="emailCopia" placeholder="ex: copia@empresa.com, outro@empresa.com">
      <button type="submit">Salvar Emails</button>
    </form>
  </section>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbwyIQSVSSZdsc1AMqBI-UiO2dLErD5UnNKrnkWjhsMs8mMGpwPRYddE9gO0X66IGJCi/exec";
    let pedidosCache = [];

    function mostrarAba(aba) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(aba).classList.add("active");
    }

    async function carregarPedidos() {
      const res = await fetch(webAppUrl);
      const pedidos = await res.json();
      pedidosCache = pedidos; // armazenar para filtro
      preencherFiltros(pedidos);
      atualizarTabela(pedidos);
    }

    function preencherFiltros(pedidos) {
      const select = document.getElementById("filtroFabrica");
      const fabricas = [...new Set(pedidos.map(p => p.fabrica))];
      select.innerHTML = '<option value="">Todas as f√°bricas</option>';
      fabricas.forEach(f => {
        const option = document.createElement("option");
        option.value = f;
        option.textContent = f;
        select.appendChild(option);
      });
    }

    function atualizarTabela(pedidos) {
      const tbody = document.querySelector("#tabelaPedidos tbody");
      tbody.innerHTML = "";
      pedidos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.numero}</td>
          <td>${p.fabrica}</td>
          <td>${p.codigo}</td>
          <td>${p.descricao}</td>
          <td>${p.quantidade}</td>
          <td>${p.dataPedido}</td>
          <td>${p.pallets}</td>
          <td>${p.peso}</td>
          <td>${p.estoque}</td>
          <td>${p.pdf ? `<a href="${p.pdf}" target="_blank">Abrir</a>` : '‚Äî'}</td>
          <td><input type="file" accept="application/pdf" onchange="uploadPDF('${p.numero}', '${p.codigo}', this)"></td>
          <td style="text-align:center;">
            <div class="btn-email" onclick="enviarEmail('${p.numero}', '${p.fabrica}', '${p.codigo}', '${p.descricao}', '${p.quantidade}', '${p.pdf || ""}')">üìß</div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filtro em tempo real
    document.getElementById("filtroFabrica").addEventListener("change", aplicarFiltros);
    document.getElementById("filtroNumero").addEventListener("input", aplicarFiltros);

    function aplicarFiltros() {
      const numero = document.getElementById("filtroNumero").value.trim();
      const fabrica = document.getElementById("filtroFabrica").value;
      let filtrados = pedidosCache;
      if (numero) filtrados = filtrados.filter(p => p.numero.includes(numero));
      if (fabrica) filtrados = filtrados.filter(p => p.fabrica === fabrica);
      atualizarTabela(filtrados);
    }

    async function uploadPDF(numero, codigo, input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        const base64 = e.target.result.split(",")[1];
        const res = await fetch(webAppUrl, {
          method: "POST",
          body: new URLSearchParams({ pdf: base64, nomeArquivo: file.name, numero, codigo })
        });
        const data = await res.json();
        alert(data.status === "success" ? "PDF enviado com sucesso!" : "Erro: " + data.message);
        carregarPedidos();
      };
      reader.readAsDataURL(file);
    }

    document.getElementById("formEmails").addEventListener("submit", async e => {
      e.preventDefault();
      const fabrica = document.getElementById("fabricaEmail").value.trim();
      const principal = document.getElementById("emailPrincipal").value.trim();
      const copia = document.getElementById("emailCopia").value.trim();

      const res = await fetch(webAppUrl + "?action=salvarEmail", {
        method: "POST",
        body: new URLSearchParams({ fabrica, principal, copia })
      });
      const data = await res.json();
      alert(data.status === "success" ? "Emails salvos com sucesso!" : "Erro ao salvar.");
      e.target.reset();
    });

    async function enviarEmail(numero, fabrica, codigo, descricao, quantidade, pdf) {
      const res = await fetch(webAppUrl + "?action=enviarEmail", {
        method: "POST",
        body: new URLSearchParams({ numero, fabrica, codigo, descricao, quantidade, pdf })
      });
      const data = await res.json();
      alert(data.status === "success" ? "Email enviado com sucesso!" : "Erro ao enviar: " + data.message);
    }

    carregarPedidos();
  </script>
</body>
</html>
