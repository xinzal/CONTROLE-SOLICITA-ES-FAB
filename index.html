<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visualizar Pedidos - PDF Remessa</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f2f4f8; }
  h1 { color: #003c8f; margin-bottom: 15px; }
  table { width: 100%; border-collapse: collapse; background: #fff; margin-top:10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
  th { background: #0073c9; color: white; }
  button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: #0073c9; color: #fff; }
  button:hover { background: #005fa3; }
  .modal { display: none; position: fixed; z-index: 10; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.5);}
  .modal-content { background:#fff; margin:10% auto; padding:20px; width:300px; border-radius:8px; }
  .close-btn { background:red; color:white; float:right; }
  input, select { padding:5px; margin-right:10px; margin-top:5px; }
</style>
</head>
<body>

<h1>Visualizar Pedidos - Anexar PDF</h1>

<div>
  <label for="filtroFabrica">Filtrar por Fábrica:</label>
  <select id="filtroFabrica" onchange="filtrarTabela()">
    <option value="">Todas</option>
  </select>

  <label for="pesquisaPedido" style="margin-left:20px;">Pesquisar Nº Pedido:</label>
  <input type="text" id="pesquisaPedido" oninput="filtrarTabela()" placeholder="Digite o número do pedido">
</div>

<table id="pedidosTable">
  <thead>
    <tr>
      <th>Número</th>
      <th>Fábrica</th>
      <th>Código</th>
      <th>Descrição</th>
      <th>Quantidade</th>
      <th>Data</th>
      <th>Pallets</th>
      <th>Peso</th>
      <th>Estoque</th>
      <th>PDF Remessa</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="pedidosBody">
    <tr><td colspan="11">Carregando...</td></tr>
  </tbody>
</table>

<div id="modal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="fecharModal()">X</button>
    <h2>Anexar PDF</h2>
    <input type="file" id="arquivoPDF" accept="application/pdf">
    <button onclick="enviarPDF()">Enviar</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIPpGPM7fahubUXYJdisWIcE8eQTlwXQB3Mkmn3LQk70rDROT86R-2ZPF1Q8jokfsM/exec";
let pedidos = [];
let pedidoSelecionado = null;

// ===== CARREGAR PEDIDOS =====
async function carregarPedidos() {
  const tbody = document.getElementById("pedidosBody");
  tbody.innerHTML = "<tr><td colspan='11'>Carregando...</td></tr>";

  try {
    const res = await fetch(WEB_APP_URL);
    pedidos = await res.json();
    tbody.innerHTML = "";
    pedidos.forEach((p, i) => {
      const tr = document.createElement("tr");
      tr.dataset.index = i;
      tr.dataset.numero = p.numero;
      tr.dataset.fabrica = p.fabrica;
      tr.dataset.codigo = p.codigo;
      tr.innerHTML = `
        <td>${p.numero}</td>
        <td>${p.fabrica}</td>
        <td>${p.codigo}</td>
        <td>${p.descricao}</td>
        <td>${p.quantidade}</td>
        <td>${p.dataPedido}</td>
        <td>${p.pallets}</td>
        <td>${p.peso}</td>
        <td>${p.estoque}</td>
        <td>${p.pdf ? `<a href="${p.pdf}" target="_blank">Ver PDF</a>` : ""}</td>
        <td><button onclick="abrirModal(${i})">Anexar PDF</button></td>
      `;
      tbody.appendChild(tr);
    });

    atualizarFiltroFabrica();
    filtrarTabela();

  } catch(err) {
    tbody.innerHTML = "<tr><td colspan='11'>Erro ao carregar pedidos</td></tr>";
  }
}

// ===== FILTRO =====
function atualizarFiltroFabrica() {
  const select = document.getElementById("filtroFabrica");
  select.innerHTML = "<option value=''>Todas</option>";
  const fabricas = [...new Set(pedidos.map(p => p.fabrica))];
  fabricas.forEach(f => {
    const option = document.createElement("option");
    option.value = f;
    option.textContent = f;
    select.appendChild(option);
  });
}

function filtrarTabela() {
  const filtroFabrica = document.getElementById("filtroFabrica").value.toLowerCase();
  const pesquisaPedido = document.getElementById("pesquisaPedido").value.toLowerCase();
  const linhas = document.querySelectorAll("#pedidosBody tr");
  linhas.forEach(tr => {
    const numero = tr.dataset.numero.toLowerCase();
    const fabrica = tr.dataset.fabrica.toLowerCase();
    const mostrar = (filtroFabrica === "" || fabrica === filtroFabrica) &&
                    (pesquisaPedido === "" || numero.includes(pesquisaPedido));
    tr.style.display = mostrar ? "" : "none";
  });
}

// ===== MODAL =====
function abrirModal(index) {
  pedidoSelecionado = index;
  document.getElementById("modal").style.display = "block";
}

function fecharModal() {
  document.getElementById("modal").style.display = "none";
  document.getElementById("arquivoPDF").value = "";
}

// ===== ENVIAR PDF =====
async function enviarPDF() {
  const fileInput = document.getElementById("arquivoPDF");
  if (!fileInput.files.length) { alert("Selecione um PDF"); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = async function(e) {
    const base64 = e.target.result.split(",")[1];
    const p = pedidos[pedidoSelecionado];

    const formData = new FormData();
    formData.append("pdf", base64);
    formData.append("nomeArquivo", file.name);
    formData.append("numero", p.numero);
    formData.append("codigo", p.codigo);

    try {
      const res = await fetch(WEB_APP_URL, { method: "POST", body: formData });
      const result = await res.json();
      if (result.status === "success") {
        alert("PDF enviado com sucesso!");
        carregarPedidos();
        fecharModal();
      } else {
        alert("Erro: " + result.message);
      }
    } catch(err) {
      alert("Erro de conexão.");
    }
  }
  reader.readAsDataURL(file);
}

// Fechar modal ao clicar fora
window.onclick = function(event) {
  if(event.target === document.getElementById("modal")) fecharModal();
}

carregarPedidos();
</script>
</body>
</html>
