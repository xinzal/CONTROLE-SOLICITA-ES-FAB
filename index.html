<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Solicitações FAB</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
  }
  header {
    background: #1a73e8;
    color: white;
    padding: 10px;
    text-align: center;
  }
  nav {
    display: flex;
    justify-content: center;
    background: #e0e0e0;
    padding: 10px;
  }
  nav button {
    margin: 0 10px;
    padding: 10px 20px;
    background: #1a73e8;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  nav button:hover {
    background: #155cb0;
  }
  section {
    display: none;
    padding: 20px;
  }
  section.active {
    display: block;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #f0f0f0;
  }
  input, select {
    padding: 6px;
    margin: 5px 0;
    width: 100%;
    box-sizing: border-box;
  }
  button.upload {
    background: #34a853;
    color: white;
  }
  button.email {
    background: #fbbc05;
    color: black;
  }
</style>
</head>
<body>
  <header>
    <h1>Controle Solicitações FAB</h1>
  </header>

  <nav>
    <button onclick="mostrarAba('pedidos')">Pedidos</button>
    <button onclick="mostrarAba('emails')">Cadastro de Emails</button>
  </nav>

  <!-- ABA DE PEDIDOS -->
  <section id="pedidos" class="active">
    <h2>Pedidos</h2>
    <table id="tabelaPedidos">
      <thead>
        <tr>
          <th>Número</th>
          <th>Fábrica</th>
          <th>Código</th>
          <th>Descrição</th>
          <th>Quantidade</th>
          <th>Data</th>
          <th>Pallets</th>
          <th>Peso</th>
          <th>Estoque</th>
          <th>PDF</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ABA DE EMAILS -->
  <section id="emails">
    <h2>Cadastro de Emails</h2>
    <form id="formEmails">
      <label>Fábrica:</label>
      <input type="text" id="fabricaEmail" required>
      <label>Email principal:</label>
      <input type="text" id="emailPrincipal" placeholder="ex: fabrica@empresa.com, outro@empresa.com">
      <label>Email cópia:</label>
      <input type="text" id="emailCopia" placeholder="ex: copia@empresa.com, outro@empresa.com">
      <button type="submit">Salvar Emails</button>
    </form>
  </section>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbwyIQSVSSZdsc1AMqBI-UiO2dLErD5UnNKrnkWjhsMs8mMGpwPRYddE9gO0X66IGJCi/exec";

    function mostrarAba(aba) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(aba).classList.add("active");
    }

    // ===== CARREGAR PEDIDOS =====
    async function carregarPedidos() {
      const res = await fetch(webAppUrl);
      const pedidos = await res.json();
      const tbody = document.querySelector("#tabelaPedidos tbody");
      tbody.innerHTML = "";
      pedidos.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.numero}</td>
          <td>${p.fabrica}</td>
          <td>${p.codigo}</td>
          <td>${p.descricao}</td>
          <td>${p.quantidade}</td>
          <td>${p.dataPedido}</td>
          <td>${p.pallets}</td>
          <td>${p.peso}</td>
          <td>${p.estoque}</td>
          <td>${p.pdf ? `<a href="${p.pdf}" target="_blank">Abrir</a>` : '—'}</td>
          <td>
            <input type="file" accept="application/pdf" onchange="uploadPDF('${p.numero}', '${p.codigo}', this)">
            <button class="email" onclick="enviarEmail('${p.numero}', '${p.fabrica}', '${p.codigo}', '${p.descricao}', '${p.quantidade}', '${p.pdf || ""}')">Enviar Email</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===== UPLOAD PDF =====
    async function uploadPDF(numero, codigo, input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async e => {
        const base64 = e.target.result.split(",")[1];
        const res = await fetch(webAppUrl, {
          method: "POST",
          body: new URLSearchParams({
            pdf: base64,
            nomeArquivo: file.name,
            numero,
            codigo
          })
        });
        const data = await res.json();
        alert(data.status === "success" ? "PDF enviado com sucesso!" : "Erro: " + data.message);
        carregarPedidos();
      };
      reader.readAsDataURL(file);
    }

    // ===== SALVAR EMAILS =====
    document.getElementById("formEmails").addEventListener("submit", async e => {
      e.preventDefault();
      const fabrica = document.getElementById("fabricaEmail").value.trim();
      const principal = document.getElementById("emailPrincipal").value.trim();
      const copia = document.getElementById("emailCopia").value.trim();

      const res = await fetch(webAppUrl + "?action=salvarEmail", {
        method: "POST",
        body: new URLSearchParams({ fabrica, principal, copia })
      });
      const data = await res.json();
      alert(data.status === "success" ? "Emails salvos com sucesso!" : "Erro ao salvar.");
      e.target.reset();
    });

    // ===== ENVIAR EMAIL =====
    async function enviarEmail(numero, fabrica, codigo, descricao, quantidade, pdf) {
      const res = await fetch(webAppUrl + "?action=enviarEmail", {
        method: "POST",
        body: new URLSearchParams({ numero, fabrica, codigo, descricao, quantidade, pdf })
      });
      const data = await res.json();
      alert(data.status === "success" ? "Email enviado com sucesso!" : "Erro ao enviar: " + data.message);
    }

    carregarPedidos();
  </script>
</body>
</html>
